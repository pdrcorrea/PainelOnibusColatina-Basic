<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PontoView ‚Ä¢ Painel de √înibus</title>

  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />
  <!-- Fonte -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Fundo */
      --bg0:#081423;
      --bg1:#0a2232;

      /* Card */
      --panel:#ffffff;
      --panel2:#f5f7fb;

      --text:#0f172a;
      --dim:#475569;

      --stroke:#d8e1ee;
      --stroke2:#e6edf7;

      --shadow: 0 18px 60px rgba(2,10,23,.18);

      --r: 18px;
      --pad: clamp(14px, 2.2vw, 26px);

      /* Cabe√ßalho integrado */
      --header: linear-gradient(90deg, #0b2c5a, #1976b7);

      /* Cores empresas */
      --vjd: #0b2c5a; /* azul escuro */
      --vsr: #1ea7ff; /* azul claro */

      /* Destaque pr√≥ximo √¥nibus */
      --okBg: #1fb86a;
      --okText: #ffffff;

      /* Escalas (TV-friendly) */
      --title: clamp(22px, 2.2vh, 42px);
      --sub: clamp(12px, 1.2vh, 18px);
      --clock: clamp(34px, 3.8vh, 70px);
      --small: clamp(11px, 1.1vh, 15px);

      --lineNum: clamp(34px, 4.2vh, 62px);
      --dest: clamp(18px, 2.3vh, 30px);

      --pill: clamp(11px, 1.15vh, 14px);
      --meta: clamp(11px, 1.1vh, 14px);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      overflow:hidden;
      background:
        radial-gradient(1200px 900px at 25% 10%, rgba(87,184,231,.22) 0%, rgba(10,46,62,0) 60%),
        radial-gradient(900px 700px at 75% 80%, rgba(52,198,208,.14) 0%, rgba(6,18,24,0) 65%),
        radial-gradient(1400px 1100px at 50% 55%, var(--bg1) 0%, var(--bg0) 62%, #040a0f 100%);
      padding: clamp(12px, 2vw, 22px);
      display:grid;
      place-items:center;
    }

    /* Card principal (cabe√ßalho + conte√∫do) */
    .panel{
      width: min(1500px, 96vw);
      height: calc(100vh - clamp(24px, 4vw, 44px));
      border-radius: var(--r);
      background: var(--panel);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;

      opacity:0;
      transform: translateY(10px);
      animation: in 800ms cubic-bezier(.22,1,.36,1) forwards;
      position:relative;
    }
    @keyframes in{ to{ opacity:1; transform:none; } }

    /* Cabe√ßalho integrado */
    .header{
      background: var(--header);
      color:#fff;
      padding: 18px var(--pad);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 16px;
    }
    .h-left{
      display:flex;
      align-items:center;
      gap: 16px;
      min-width:0;
    }
    .iconBox{
      width: clamp(44px, 5vh, 60px);
      height: clamp(44px, 5vh, 60px);
      border-radius: 16px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,.14);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.18);
      flex:0 0 auto;
    }
    .iconBox .material-icons-outlined{
      font-size: clamp(22px, 2.6vh, 30px);
    }
    .titleBlock{ min-width:0; }
    .title{
      font-size: var(--title);
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      line-height: 1.1;
    }
    .sub{
      margin-top: 6px;
      font-size: var(--sub);
      font-weight: 800;
      letter-spacing: .12em;
      text-transform: uppercase;
      opacity: .9;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 70vw;
      line-height: 1.2;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .sub .material-icons-outlined{
      font-size: clamp(16px, 1.8vh, 22px);
      opacity:.95;
    }

    .h-right{
      text-align:right;
      white-space:nowrap;
      display:flex;
      flex-direction:column;
      gap: 6px;
      align-items:flex-end;
    }
    .clock{
      font-size: var(--clock);
      font-weight: 900;
      letter-spacing: .06em;
      line-height: 1;
    }
    .lastUpdate{
      font-size: var(--small);
      font-weight: 900;
      letter-spacing: .12em;
      text-transform: uppercase;
      opacity: .9;
    }

    /* Faixa superior do conte√∫do */
    .topline{
      padding: 12px var(--pad);
      background: #f3f7ff;
      border-bottom: 1px solid var(--stroke2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }
    .topInfo{
      font-size: var(--small);
      font-weight: 900;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: #1f2a44;
    }

    /* √Årea lista (com pagina√ß√£o) */
    .body{
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    .listWrap{
      flex:1;
      min-height:0;
      padding: clamp(14px, 2.2vw, 28px);
      display:flex;
      flex-direction:column;
      gap: 12px;
      overflow:hidden;
    }

    /* P√°gina (anima√ß√£o) */
    .page{
      display:grid;
      gap: 12px;
      align-content:start;
      opacity:0;
      transform: translateY(10px);
      animation: pageIn 520ms cubic-bezier(.22,1,.36,1) forwards;
    }
    @keyframes pageIn{
      to{ opacity:1; transform:none; }
    }

    /* Cards de linha */
    .card{
      border-radius: 16px;
      border: 1px solid var(--stroke2);
      background: var(--panel2);
      padding: clamp(12px, 1.8vh, 18px);
      display:grid;
      grid-template-columns: 120px 1fr 250px;
      gap: 14px;
      align-items:center;
      position:relative;
      overflow:hidden;
      min-height: clamp(84px, 9vh, 120px);
    }

    /* Faixa lateral cor empresa */
    .card::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width: 10px;
      background: var(--vjd);
    }
    .card.vsr::before{ background: var(--vsr); }

    .leftCol{
      padding-left: 8px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      align-items:flex-start;
    }
    .lineNum{
      font-size: var(--lineNum);
      font-weight: 900;
      letter-spacing: .02em;
      line-height: 1;
      color:#0b1220;
    }

    /* Badge empresa (abaixo do n√∫mero) */
    .company{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.10);
      background: #ffffff;
      font-size: var(--meta);
      font-weight: 900;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: #0b1220;
    }
    .dot{
      width: 10px; height: 10px; border-radius: 50%;
      background: var(--vjd);
    }
    .vsr .dot{ background: var(--vsr); }

    .midCol{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .dest{
      font-size: var(--dest);
      font-weight: 900;
      letter-spacing: .02em;
      text-transform: uppercase;
      color:#0b1220;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .metaLine{
      font-size: var(--meta);
      font-weight: 900;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: var(--dim);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Coluna hor√°rios: destaque + p√≠lulas em 1 linha (abaixo) */
    .rightCol{
      justify-self:end;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap: 10px;
    }
    .nextTime{
      padding: 12px 18px;
      border-radius: 12px;
      background: var(--okBg);
      color: var(--okText);
      font-weight: 900;
      letter-spacing: .08em;
      font-size: clamp(20px, 2.4vh, 34px);
      line-height: 1;
      box-shadow: 0 10px 22px rgba(31,184,106,.25);
    }

    .pills{
      display:flex;
      gap: 10px;
      flex-wrap: nowrap;           /* ‚úÖ uma linha */
      overflow:hidden;             /* evita quebrar layout */
      max-width: 100%;
    }
    .pill{
      flex: 0 0 auto;
      padding: 8px 10px;
      border-radius: 999px;
      background:#ffffff;
      border: 1px solid var(--stroke2);
      font-size: var(--pill);
      font-weight: 900;
      letter-spacing: .10em;
      color:#0b1220;
      white-space:nowrap;
    }

    /* Rodap√© (pagina√ß√£o + barra de progresso) */
    .footer{
      padding: 10px var(--pad) 14px;
      border-top: 1px solid var(--stroke2);
      background: #ffffff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 16px;
    }

    .pageInfo{
      font-size: var(--small);
      font-weight: 900;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: var(--dim);
      white-space:nowrap;
    }

    .progress{
      flex: 1;
      height: 10px;
      border-radius: 999px;
      background: #eef4ff;
      border: 1px solid var(--stroke2);
      overflow:hidden;
      max-width: 520px;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(30,167,255,.90), rgba(11,44,90,.90));
      border-radius: 999px;
    }

    /* Placeholder vazio */
    .empty{
      flex:1;
      display:grid;
      place-items:center;
      color: var(--dim);
      font-weight: 900;
      letter-spacing: .12em;
      text-transform: uppercase;
      font-size: clamp(12px, 1.2vh, 18px);
    }

    /* Logo discreta no canto (sem badge) */
    .brand{
      position:absolute;
      right: 18px;
      bottom: 14px;
      z-index: 5;
      pointer-events:none;
      opacity: .22;
      filter: drop-shadow(0 2px 0 rgba(15,23,42,.25))
              drop-shadow(0 10px 16px rgba(0,0,0,.08));
    }
    .brand img{
      height: clamp(16px, 2.2vh, 28px);
      width:auto;
      display:block;
    }

    @media (max-width: 980px){
      body{ overflow:auto; }
      .panel{ height:auto; }
      .card{ grid-template-columns: 120px 1fr; grid-template-rows:auto auto; }
      .rightCol{ grid-column: 1 / -1; align-items:flex-start; justify-self:start; }
      .pills{ max-width: 100%; }
      .progress{ max-width: 360px; }
      .brand{ position:static; opacity:.32; margin: 0 18px 16px auto; width: fit-content; }
    }
  </style>
</head>

<body>
  <section class="panel" aria-label="Painel de √¥nibus">
    <!-- Cabe√ßalho integrado -->
    <div class="header">
      <div class="h-left">
        <div class="iconBox" aria-hidden="true">
          <span class="material-icons-outlined">directions_bus</span>
        </div>
        <div class="titleBlock">
          <div class="title">Painel de √înibus</div>
          <div class="sub" id="stationLine">
            <span class="material-icons-outlined" aria-hidden="true">location_on</span>
            <span id="stationName">Esta√ß√£o Central</span>
          </div>
        </div>
      </div>

      <div class="h-right">
        <div class="clock" id="clock">--:--</div>
        <div class="lastUpdate" id="statusLine">Carregando‚Ä¶</div>
      </div>
    </div>

    <!-- Faixa topo do conte√∫do -->
    <div class="topline">
      <div class="topInfo" id="rangeInfo">Pr√≥ximas sa√≠das ‚Ä¢ janela 2h</div>
      <div class="topInfo" id="sourceInfo">Fonte ‚Ä¢ Google Maps Transit</div>
    </div>

    <div class="body">
      <div class="listWrap" id="listWrap">
        <div class="page" id="page"></div>
      </div>

      <div class="footer">
        <div class="pageInfo" id="pageInfo">P√°gina ‚Äî/‚Äî</div>
        <div class="progress" aria-label="Tempo para troca de p√°gina">
          <div class="bar" id="bar"></div>
        </div>
        <div class="pageInfo" id="updatedInfo">Atualizado ‚Ä¢ ‚Äî</div>
      </div>
    </div>

    <div class="brand" aria-hidden="true">
      <img src="assets/logo.png" alt="">
    </div>
  </section>

  <script>
    /*******************************************************************
     * üîë COLE SUA GOOGLE MAPS API KEY AQUI
     *******************************************************************/
    const GOOGLE_MAPS_API_KEY = "AIzaSyA5jfERk5m06bl0eQnFLWSYbFhsQFglyO8";

    /*******************************************************************
     * CONFIG
     *******************************************************************/
    const STATION = { lat: -19.5368231, lng: -40.633973 };
    const STATION_LABEL = "Esta√ß√£o Central";

    const SWEEP_POINTS = 12;            // 360¬∫ / 30¬∫
    const SWEEP_RADIUS_M = 1200;        // ajuste 800‚Äì2000m
    const REFRESH_EVERY_MS = 10 * 60 * 1000;

    const TIME_WINDOW_MIN = 120;        // ‚úÖ somente pr√≥ximas 2h

    // Pagina√ß√£o
    const PAGE_DURATION_MS = 9000;      // tempo de cada p√°gina
    const PAGE_SWITCH_ANIM_MS = 520;    // deve casar com @keyframes pageIn

    /*******************************************************************
     * UI refs
     *******************************************************************/
    const clockEl = document.getElementById("clock");
    const statusLineEl = document.getElementById("statusLine");
    const updatedInfoEl = document.getElementById("updatedInfo");
    const pageInfoEl = document.getElementById("pageInfo");
    const barEl = document.getElementById("bar");
    const pageEl = document.getElementById("page");
    const listWrapEl = document.getElementById("listWrap");

    document.getElementById("stationName").textContent = STATION_LABEL;

    /*******************************************************************
     * Clock (sem segundos)
     *******************************************************************/
    function pad2(n){ return String(n).padStart(2,"0"); }
    function tickClock(){
      const d = new Date();
      clockEl.textContent = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }
    tickClock();
    setInterval(tickClock, 1000);

    /*******************************************************************
     * Loader Google Maps
     *******************************************************************/
    function loadGoogleMaps(){
      return new Promise((resolve, reject) => {
        if (window.google?.maps) return resolve();

        const key = (GOOGLE_MAPS_API_KEY || "").trim();
        if (!key || key === "COLE_SUA_API_KEY_AQUI"){
          statusLineEl.textContent = "Insira sua API Key";
          return reject(new Error("Missing API key"));
        }

        const script = document.createElement("script");
        script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}`;
        script.async = true;
        script.defer = true;
        script.onload = () => resolve();
        script.onerror = () => reject(new Error("Falha ao carregar Google Maps JS API"));
        document.head.appendChild(script);
      });
    }

    /*******************************************************************
     * Geodesia (destino por bearing)
     *******************************************************************/
    function toRad(deg){ return deg * Math.PI / 180; }
    function toDeg(rad){ return rad * 180 / Math.PI; }

    function destinationPoint(lat, lng, bearingDeg, distanceM){
      const R = 6371000;
      const brng = toRad(bearingDeg);
      const dDivR = distanceM / R;
      const lat1 = toRad(lat);
      const lon1 = toRad(lng);

      const lat2 = Math.asin(
        Math.sin(lat1)*Math.cos(dDivR) +
        Math.cos(lat1)*Math.sin(dDivR)*Math.cos(brng)
      );
      const lon2 = lon1 + Math.atan2(
        Math.sin(brng)*Math.sin(dDivR)*Math.cos(lat1),
        Math.cos(dDivR) - Math.sin(lat1)*Math.sin(lat2)
      );

      return { lat: toDeg(lat2), lng: toDeg(lon2) };
    }

    function buildSweepDestinations(){
      const points = [];
      for (let i=0;i<SWEEP_POINTS;i++){
        const bearing = i * (360 / SWEEP_POINTS);
        points.push(destinationPoint(STATION.lat, STATION.lng, bearing, SWEEP_RADIUS_M));
      }
      return points;
    }

    /*******************************************************************
     * Empresa por n√∫mero de linha
     *******************************************************************/
    function companyFromLineNumber(lineShort){
      const n = parseInt(String(lineShort).replace(/\D/g,""), 10);
      if (!Number.isFinite(n)) return { code:"VJD", cls:"vjd", color:"var(--vjd)" };
      if (n >= 300 && n <= 499) return { code:"VSR", cls:"vsr", color:"var(--vsr)" };
      return { code:"VJD", cls:"vjd", color:"var(--vjd)" };
    }

    /*******************************************************************
     * Parsing Directions (TRANSIT)
     *******************************************************************/
    function extractTripsFromDirectionsResult(result){
      const trips = [];
      if (!result?.routes?.length) return trips;

      for (const route of result.routes){
        const leg = route.legs?.[0];
        if (!leg?.steps?.length) continue;

        for (const step of leg.steps){
          if (step.travel_mode !== "TRANSIT" || !step.transit) continue;

          const td = step.transit;
          const lineShort = td.line?.short_name || td.line?.name || "‚Äî";
          const headsign = td.headsign || td.line?.name || td.arrival_stop?.name || "Destino";

          const dep = td.departure_time?.value; // epoch seconds
          const arr = td.arrival_time?.value;   // epoch seconds
          const timeMs = (arr ? arr*1000 : (dep ? dep*1000 : null));
          if (!timeMs) continue;

          trips.push({
            line: String(lineShort),
            destination: String(headsign),
            timeMs,
            key: `${String(lineShort)}|${String(headsign)}|${timeMs}`
          });
        }
      }
      return trips;
    }

    /*******************************************************************
     * Aggregation + filtro 2h
     *******************************************************************/
    function aggregateTrips(allTrips){
      const uniqMap = new Map();
      for (const t of allTrips) uniqMap.set(t.key, t);
      const uniq = Array.from(uniqMap.values());

      const groups = new Map();
      for (const t of uniq){
        const gKey = `${t.line}||${t.destination}`;
        if (!groups.has(gKey)) groups.set(gKey, { line: t.line, destination: t.destination, times: [] });
        groups.get(gKey).times.push(t.timeMs);
      }

      const now = Date.now();
      const maxMs = now + TIME_WINDOW_MIN * 60 * 1000;

      const cards = [];
      for (const g of groups.values()){
        g.times.sort((a,b) => a-b);

        // remove passado e corta para janela 2h
        g.times = g.times.filter(ms => ms >= now - 30_000 && ms <= maxMs);

        if (!g.times.length) continue;

        cards.push({
          line: g.line,
          destination: g.destination,
          times: g.times,
          nextTime: g.times[0]
        });
      }

      cards.sort((a,b) => a.nextTime - b.nextTime);
      return cards;
    }

    function fmtHHMM(ms){
      const d = new Date(ms);
      return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    /*******************************************************************
     * Render de uma p√°gina (subset)
     *******************************************************************/
    function renderPage(items){
      pageEl.innerHTML = "";
      pageEl.className = "page"; // reinicia anima√ß√£o
      void pageEl.offsetWidth;   // force reflow p/ reanimar

      if (!items.length){
        pageEl.innerHTML = `<div class="empty">Nenhuma sa√≠da encontrada nas pr√≥ximas 2 horas.</div>`;
        return;
      }

      const frag = document.createDocumentFragment();

      for (const c of items){
        const comp = companyFromLineNumber(c.line);
        const el = document.createElement("div");
        el.className = `card ${comp.cls}`;

        const next = c.times[0];
        const rest = c.times.slice(1); // p√≠lulas

        el.innerHTML = `
          <div class="leftCol">
            <div class="lineNum">${escapeHtml(c.line)}</div>
            <div class="company">
              <span class="dot"></span>
              <span>${comp.code}</span>
            </div>
          </div>

          <div class="midCol">
            <div class="dest">${escapeHtml(c.destination)}</div>
            <div class="metaLine">Pr√≥ximos: ${c.times.map(fmtHHMM).join(" ‚Ä¢ ")}</div>
          </div>

          <div class="rightCol">
            <div class="nextTime">${fmtHHMM(next)}</div>
            <div class="pills">
              ${rest.map(ms => `<div class="pill">${fmtHHMM(ms)}</div>`).join("")}
            </div>
          </div>
        `;

        frag.appendChild(el);
      }

      pageEl.appendChild(frag);
    }

    /*******************************************************************
     * Pagina√ß√£o din√¢mica (baseada no espa√ßo dispon√≠vel)
     *******************************************************************/
    function estimateRowsPerPage(totalCards){
      // Render tempor√°rio 1 card para medir altura e calcular quantos cabem
      if (totalCards <= 1) return totalCards;

      const probe = document.createElement("div");
      probe.className = "card";
      probe.style.visibility = "hidden";
      probe.style.position = "absolute";
      probe.style.left = "-9999px";
      probe.innerHTML = `
        <div class="leftCol"><div class="lineNum">000</div><div class="company"><span class="dot"></span><span>VJD</span></div></div>
        <div class="midCol"><div class="dest">DESTINO EXEMPLO</div><div class="metaLine">Pr√≥ximos: 00:00 ‚Ä¢ 00:00</div></div>
        <div class="rightCol"><div class="nextTime">00:00</div><div class="pills"><div class="pill">00:00</div></div></div>
      `;
      document.body.appendChild(probe);

      const cardH = probe.getBoundingClientRect().height || 110;
      document.body.removeChild(probe);

      const wrapH = listWrapEl.getBoundingClientRect().height || 600;
      // considera gap ~12px
      const per = Math.max(4, Math.floor(wrapH / (cardH + 12)));
      return per;
    }

    /*******************************************************************
     * Progress bar + troca de p√°gina
     *******************************************************************/
    let cardsState = [];
    let pageIndex = 0;
    let pageTimer = null;
    let progressTimer = null;

    function stopPaging(){
      if (pageTimer) clearInterval(pageTimer);
      if (progressTimer) clearInterval(progressTimer);
      pageTimer = null;
      progressTimer = null;
    }

    function startPaging(){
      stopPaging();
      if (!cardsState.length){
        renderPage([]);
        pageInfoEl.textContent = `P√°gina 0/0`;
        barEl.style.width = "0%";
        return;
      }

      const perPage = estimateRowsPerPage(cardsState.length);
      const totalPages = Math.max(1, Math.ceil(cardsState.length / perPage));

      function draw(){
        const start = pageIndex * perPage;
        const slice = cardsState.slice(start, start + perPage);
        renderPage(slice);
        pageInfoEl.textContent = `P√°gina ${pageIndex+1}/${totalPages}`;
      }

      draw();

      // Progress bar
      let t = 0;
      barEl.style.width = "0%";

      progressTimer = setInterval(() => {
        t += 100;
        const pct = Math.min(100, (t / PAGE_DURATION_MS) * 100);
        barEl.style.width = pct.toFixed(1) + "%";
      }, 100);

      pageTimer = setInterval(() => {
        pageIndex = (pageIndex + 1) % totalPages;

        // reinicia progress
        t = 0;
        barEl.style.width = "0%";

        draw();
      }, PAGE_DURATION_MS);

      // Recalcular p√°ginas se a janela mudar
      window.addEventListener("resize", () => {
        // recome√ßa pagina√ß√£o para recalcular perPage
        pageIndex = 0;
        startPaging();
      }, { passive:true, once:true });
    }

    /*******************************************************************
     * Directions: 12 requisi√ß√µes simult√¢neas
     *******************************************************************/
    let directionsService = null;
    let refreshTimer = null;

    function setStatus(text){ statusLineEl.textContent = text; }

    function requestDirectionsTo(dest){
      return new Promise((resolve) => {
        const req = {
          origin: STATION,
          destination: dest,
          travelMode: google.maps.TravelMode.TRANSIT,
          provideRouteAlternatives: true,
          transitOptions: { departureTime: new Date() }
        };

        directionsService.route(req, (result, status) => {
          if (status === "OK" && result) resolve({ ok:true, result });
          else resolve({ ok:false, status });
        });
      });
    }

    async function refreshData(){
      setStatus("Buscando linhas‚Ä¶");
      const t0 = performance.now();

      if (!directionsService) directionsService = new google.maps.DirectionsService();

      const destinations = buildSweepDestinations();
      const responses = await Promise.all(destinations.map(d => requestDirectionsTo(d)));

      const allTrips = [];
      let okCount = 0;

      for (const r of responses){
        if (r.ok){
          okCount++;
          allTrips.push(...extractTripsFromDirectionsResult(r.result));
        }
      }

      cardsState = aggregateTrips(allTrips);

      const now = new Date();
      updatedInfoEl.textContent = `Atualizado ‚Ä¢ ${pad2(now.getHours())}:${pad2(now.getMinutes())}`;

      const dt = Math.round(performance.now() - t0);
      if (!okCount){
        setStatus("Sem resposta da API (verifique a KEY/restri√ß√µes)");
      } else {
        setStatus(`Linhas: ${cardsState.length} ‚Ä¢ OK: ${okCount}/12 ‚Ä¢ ${dt}ms`);
      }

      pageIndex = 0;
      startPaging();
    }

    function scheduleRefresh(){
      if (refreshTimer) clearInterval(refreshTimer);
      refreshTimer = setInterval(refreshData, REFRESH_EVERY_MS);
    }

    /*******************************************************************
     * BOOT
     *******************************************************************/
    (async function boot(){
      try{
        setStatus("Carregando Google Maps‚Ä¶");
        await loadGoogleMaps();
        setStatus("Atualizando‚Ä¶");
        await refreshData();
        scheduleRefresh();
      }catch(err){
        console.warn(err);
        setStatus("Insira sua API Key e publique novamente");
        cardsState = [];
        startPaging();
      }
    })();
    
  </script>
</body>
</html>


